# è¿›ç¨‹é—´é€šä¿¡æ–¹æ¡ˆå¯¹æ¯”

## èƒŒæ™¯
åœ¨ Python è°ƒç”¨ Node.js ç¼–è¯‘å™¨çš„åœºæ™¯ä¸­ï¼Œéœ€è¦ä¼ é€’æ•°æ®å’Œæ¥æ”¶ç»“æœã€‚å½“å‰é‡‡ç”¨ stdout æ–¹æ¡ˆï¼Œä½†å­˜åœ¨ä¸€äº›é—®é¢˜å’Œæ›´ä¼˜é›…çš„æ›¿ä»£æ–¹æ¡ˆã€‚

## å½“å‰æ–¹æ¡ˆï¼šstdout é€šä¿¡

### å®ç°æ–¹å¼
```python
# Python ç«¯
process = await asyncio.create_subprocess_exec(
    "node", "compile.js",
    stdin=asyncio.subprocess.PIPE,
    stdout=asyncio.subprocess.PIPE,
    stderr=asyncio.subprocess.PIPE
)

stdout, stderr = await process.communicate(
    input=json.dumps(input_data).encode()
)

result = json.loads(stdout.decode())
```

```javascript
// Node.js ç«¯
const input = JSON.parse(fs.readFileSync(0, 'utf8')); // ä» stdin è¯»å–
const result = await compile(input);
console.log(JSON.stringify(result)); // è¾“å‡ºåˆ° stdout
```

### é—®é¢˜
1. **è¾“å‡ºæ··ä¹±**ï¼šstdout æ··åˆäº† JSON æ•°æ®å’Œè°ƒè¯•ä¿¡æ¯
2. **è°ƒè¯•å›°éš¾**ï¼šæ— æ³•åŒæ—¶çœ‹åˆ°çŠ¶æ€ä¿¡æ¯å’Œæ•°æ®  
3. **é”™è¯¯å¤„ç†å¤æ‚**ï¼šéœ€è¦åŒºåˆ† JSON è§£æé”™è¯¯å’Œå®é™…ç¼–è¯‘é”™è¯¯
4. **ä¸å¤Ÿå¥å£®**ï¼šä»»ä½•æ„å¤–çš„ console.log éƒ½ä¼šç ´åæ•°æ®

### è§£å†³æ–¹æ¡ˆ
å°†çŠ¶æ€ä¿¡æ¯è¾“å‡ºåˆ° stderrï¼ŒJSON æ•°æ®è¾“å‡ºåˆ° stdoutï¼š
```javascript
console.error('ğŸ”§ ç¼–è¯‘å¼€å§‹...'); // çŠ¶æ€ä¿¡æ¯ -> stderr
console.log(JSON.stringify(result)); // æ•°æ® -> stdout
```

## æ›¿ä»£æ–¹æ¡ˆå¯¹æ¯”

### 1. æ–‡ä»¶é€šä¿¡ â­â­â­â­â­

**å®ç°æ–¹å¼ï¼š**
```python
# Python ç«¯
with tempfile.NamedTemporaryFile(mode='w', suffix='.json', delete=False) as input_file:
    json.dump(compile_input, input_file)
    input_file_path = input_file.name

with tempfile.NamedTemporaryFile(mode='w', suffix='.json', delete=False) as output_file:
    output_file_path = output_file.name

process = await asyncio.create_subprocess_exec(
    "node", "compile.js", 
    "--input", input_file_path,
    "--output", output_file_path,
    stderr=asyncio.subprocess.PIPE
)

await process.wait()

# è¯»å–ç»“æœ
with open(output_file_path, 'r') as f:
    result_data = json.load(f)
```

```javascript
// Node.js ç«¯
import { readFileSync, writeFileSync } from 'fs';

const args = process.argv.slice(2);
const inputFile = args[args.indexOf('--input') + 1];
const outputFile = args[args.indexOf('--output') + 1];

try {
  const inputData = JSON.parse(readFileSync(inputFile, 'utf8'));
  const result = await compile(inputData);
  writeFileSync(outputFile, JSON.stringify(result, null, 2));
  
  console.error('âœ… ç¼–è¯‘å®Œæˆ'); // çŠ¶æ€ä¿¡æ¯æ­£å¸¸è¾“å‡º
  process.exit(0);
} catch (error) {
  console.error('âŒ ç¼–è¯‘å¤±è´¥:', error.message);
  writeFileSync(outputFile, JSON.stringify({
    success: false,
    error: error.message
  }));
  process.exit(1);
}
```

**ä¼˜åŠ¿ï¼š**
- âœ… å®Œå…¨åˆ†ç¦»æ•°æ®å’Œæ—¥å¿—
- âœ… æ”¯æŒå¤§æ•°æ®é‡
- âœ… è°ƒè¯•å‹å¥½
- âœ… å®ç°ç®€å•
- âœ… è·¨å¹³å°å…¼å®¹

**åŠ£åŠ¿ï¼š**
- âŒ éœ€è¦ä¸´æ—¶æ–‡ä»¶ç®¡ç†
- âŒ ç£ç›˜ I/O å¼€é”€

### 2. HTTP API â­â­â­â­

**å®ç°æ–¹å¼ï¼š**
```python
# å¯åŠ¨ç¼–è¯‘æœåŠ¡
# node compile-server.js --port 3001

async def compile_via_http(self, request):
    async with aiohttp.ClientSession() as session:
        async with session.post(
            'http://localhost:3001/compile',
            json=request.dict()
        ) as response:
            return await response.json()
```

```javascript
// compile-server.js
import express from 'express';

const app = express();
app.use(express.json());

app.post('/compile', async (req, res) => {
  try {
    const result = await compile(req.body);
    res.json(result);
  } catch (error) {
    res.status(500).json({ error: error.message });
  }
});

app.listen(3001);
```

**ä¼˜åŠ¿ï¼š**
- âœ… æ ‡å‡†åŒ–æ¥å£
- âœ… æ”¯æŒå¤šå®¢æˆ·ç«¯
- âœ… å†…ç½®é”™è¯¯å¤„ç†
- âœ… å¯æ‰©å±•æ€§å¥½

**åŠ£åŠ¿ï¼š**
- âŒ éœ€è¦ç®¡ç†æœåŠ¡ç”Ÿå‘½å‘¨æœŸ
- âŒ ç½‘ç»œå¼€é”€
- âŒ ç«¯å£ç®¡ç†å¤æ‚

### 3. Socket é€šä¿¡ â­â­â­

**å®ç°æ–¹å¼ï¼š**
```python
# Unix Socket
import socket

def compile_via_socket(self, request):
    sock = socket.socket(socket.AF_UNIX, socket.SOCK_STREAM)
    sock.connect('/tmp/tsx_compiler.sock')
    
    sock.sendall(json.dumps(request.dict()).encode())
    response = sock.recv(1024 * 1024)  # 1MB buffer
    
    return json.loads(response.decode())
```

**ä¼˜åŠ¿ï¼š**
- âœ… æ€§èƒ½è¾ƒå¥½
- âœ… æ”¯æŒåŒå‘é€šä¿¡

**åŠ£åŠ¿ï¼š**
- âŒ è·¨å¹³å°å…¼å®¹æ€§é—®é¢˜
- âŒ å®ç°å¤æ‚åº¦é«˜
- âŒ é”™è¯¯å¤„ç†å¤æ‚

### 4. æ¶ˆæ¯é˜Ÿåˆ— â­â­

**å®ç°æ–¹å¼ï¼š**
```python
# Redis é˜Ÿåˆ—
import redis
import uuid

async def compile_via_redis(self, request):
    redis_client = redis.Redis()
    
    task_id = str(uuid.uuid4())
    redis_client.lpush('compile_tasks', json.dumps({
        'id': task_id,
        'data': request.dict()
    }))
    
    # è½®è¯¢ç»“æœ
    while True:
        result = redis_client.get(f'compile_result_{task_id}')
        if result:
            return json.loads(result)
        await asyncio.sleep(0.1)
```

**ä¼˜åŠ¿ï¼š**
- âœ… æ”¯æŒå¼‚æ­¥å¤„ç†
- âœ… æ”¯æŒä»»åŠ¡é˜Ÿåˆ—
- âœ… é«˜å¯ç”¨æ€§

**åŠ£åŠ¿ï¼š**
- âŒ ä¾èµ–å¤–éƒ¨æœåŠ¡
- âŒ å¤æ‚åº¦å¾ˆé«˜
- âŒ å»¶è¿Ÿè¾ƒé«˜

## æ–¹æ¡ˆé€‰æ‹©å»ºè®®

### é€‚ç”¨åœºæ™¯

1. **ç®€å•åœºæ™¯**ï¼šç»§ç»­ä½¿ç”¨ stdoutï¼ˆå·²è§£å†³è¾“å‡ºæ··ä¹±é—®é¢˜ï¼‰
2. **é¢‘ç¹è°ƒç”¨**ï¼šHTTP API æˆ–æ–‡ä»¶é€šä¿¡
3. **å¤§æ•°æ®é‡**ï¼šæ–‡ä»¶é€šä¿¡
4. **é«˜æ€§èƒ½è¦æ±‚**ï¼šSocket é€šä¿¡
5. **åˆ†å¸ƒå¼åœºæ™¯**ï¼šæ¶ˆæ¯é˜Ÿåˆ—

### æ¨èæ–¹æ¡ˆ

å¯¹äºå½“å‰é¡¹ç›®ï¼Œæ¨è **æ–‡ä»¶é€šä¿¡** æ–¹æ¡ˆï¼š

1. **å®ç°ç®€å•**ï¼šåªéœ€ä¿®æ”¹å‚æ•°ä¼ é€’æ–¹å¼
2. **è°ƒè¯•å‹å¥½**ï¼šçŠ¶æ€ä¿¡æ¯å¯ä»¥æ­£å¸¸è¾“å‡º
3. **æ•°æ®å®‰å…¨**ï¼šä¸ä¼šå› ä¸ºæ„å¤–è¾“å‡ºç ´åæ•°æ®
4. **æ‰©å±•æ€§å¥½**ï¼šæ”¯æŒå¤§æ–‡ä»¶å’Œå¤æ‚æ•°æ®ç»“æ„

## æ€»ç»“

| æ–¹æ¡ˆ | å®ç°éš¾åº¦ | æ€§èƒ½ | è°ƒè¯•æ€§ | å¯é æ€§ | æ¨èåº¦ |
|------|---------|------|--------|--------|--------|
| stdout | ç®€å• | é«˜ | å·® | ä¸­ | â­â­â­ |
| æ–‡ä»¶é€šä¿¡ | ç®€å• | ä¸­ | ä¼˜ | é«˜ | â­â­â­â­â­ |
| HTTP API | ä¸­ | ä¸­ | ä¼˜ | é«˜ | â­â­â­â­ |
| Socket | å¤æ‚ | é«˜ | ä¸­ | ä¸­ | â­â­â­ |
| æ¶ˆæ¯é˜Ÿåˆ— | å¤æ‚ | ä½ | ä¸­ | é«˜ | â­â­ |

**ç»“è®º**ï¼šå½“å‰é¡¹ç›®å·²é€šè¿‡ stderr/stdout åˆ†ç¦»è§£å†³äº†ä¸»è¦é—®é¢˜ï¼Œå¦‚æœæœªæ¥éœ€è¦æ›´å¥½çš„æ‰©å±•æ€§å’Œè°ƒè¯•ä½“éªŒï¼Œå»ºè®®è¿ç§»åˆ°æ–‡ä»¶é€šä¿¡æ–¹æ¡ˆã€‚